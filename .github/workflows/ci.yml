name: CI Pipeline

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened, labeled]

jobs:
  enrich-description:
    name: Enrich PR Description
    if: >-
      github.event.action == 'opened' ||
      (github.event.action == 'labeled' && github.event.label.name == 'rerun')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract task number from branch name
        id: extract
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ "$BRANCH" =~ task-([0-9]+) ]]; then
            echo "task_number=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
            echo "Found task number: ${BASH_REMATCH[1]} in branch: $BRANCH"
          else
            echo "No task number found in branch: $BRANCH"
            echo "task_number=" >> "$GITHUB_OUTPUT"
          fi

      - name: Build task content
        id: build
        run: |
          TASK_NUM="${{ steps.extract.outputs.task_number }}"
          BRANCH="${{ github.head_ref }}"

          if [ -z "$TASK_NUM" ]; then
            cat > /tmp/task_content.md <<EOF
          > **Warning:** No task number detected in branch name \`${BRANCH}\`.
          > Expected format: \`feat/task-{N}-description\` or \`chore/task-{N}-description\`.
          > Fill in the Task Reference section manually if needed.
          EOF
            echo "has_content=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TASKS_FILE="./ai/tasks.md"

          if [ ! -f "$TASKS_FILE" ]; then
            cat > /tmp/task_content.md <<EOF
          > **Warning:** \`ai/tasks.md\` not found. Cannot auto-populate task reference.
          EOF
            echo "has_content=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SECTION=$(awk '
            /^### Task '"$TASK_NUM"':/ { found=1; next }
            found && /^### Task [0-9]+:/ { found=0 }
            found && /^---$/ { found=0 }
            found && /^## / { found=0 }
            found { print }
          ' "$TASKS_FILE")

          if [ -z "$SECTION" ]; then
            cat > /tmp/task_content.md <<EOF
          > **Warning:** Task $TASK_NUM not found in \`ai/tasks.md\`.
          EOF
            echo "has_content=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TITLE=$(grep -oP "^### Task ${TASK_NUM}: \K.*" "$TASKS_FILE" | sed 's/ ✅ COMPLETED//')

          DESCRIPTION=$(echo "$SECTION" | awk '/^\*\*Description:\*\*/{flag=1; sub(/\*\*Description:\*\* */,""); print; next} flag && /^\*\*/{flag=0} flag{print}')

          SCOPE=$(echo "$SECTION" | awk '/^\*\*Scope:\*\*/{flag=1; next} flag && /^- /{print} flag && !/^- / && !/^$/{flag=0}')

          REVIEW_RULES=$(echo "$SECTION" | grep -oP '^\*\*Claude review:\*\* \K.*' || true)

          EXPECTED=$(echo "$SECTION" | awk '/^\*\*Expected review points:\*\*/{flag=1; next} flag && /^- \[/{print} flag && !/^- \[/ && !/^$/{flag=0}')

          {
            echo "### Task ${TASK_NUM}: ${TITLE}"
            echo ""
            if [ -n "$DESCRIPTION" ]; then
              echo "**Description:** ${DESCRIPTION}"
              echo ""
            fi
            if [ -n "$SCOPE" ]; then
              echo "**Scope:**"
              echo "${SCOPE}"
              echo ""
            fi
            if [ -n "$REVIEW_RULES" ]; then
              echo "**Claude review:** ${REVIEW_RULES}"
              echo ""
            fi
            if [ -n "$EXPECTED" ]; then
              echo "**Expected review points:**"
              echo "${EXPECTED}"
            fi
          } > /tmp/task_content.md

          echo "has_content=true" >> "$GITHUB_OUTPUT"

      - name: Update PR description
        if: steps.build.outputs.has_content == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"

          gh pr view "$PR_NUM" --json body --jq '.body' > /tmp/current_body.md

          python3 -c "
          with open('/tmp/current_body.md', 'r') as f:
              body = f.read()
          with open('/tmp/task_content.md', 'r') as f:
              replacement = f.read()
          placeholder = '<!-- TASK_PLACEHOLDER -->'
          if placeholder in body:
              body = body.replace(placeholder, replacement)
              with open('/tmp/new_body.md', 'w') as f:
                  f.write(body)
              print('Placeholder found and replaced')
          else:
              print('No TASK_PLACEHOLDER found in PR body (already enriched or missing), skipping')
          "

          if [ -f /tmp/new_body.md ]; then
            gh pr edit "$PR_NUM" --body-file /tmp/new_body.md
            echo "PR description enriched successfully"
          fi

  checkstyle:
    name: Checkstyle
    needs: enrich-description
    if: >-
      always() &&
      needs.enrich-description.result != 'failure' &&
      (github.event.action != 'labeled' || github.event.label.name == 'rerun')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        run: ./mvnw checkstyle:check

  test:
    name: Unit Tests
    needs: checkstyle
    if: always() && needs.checkstyle.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Tests
        run: ./mvnw test

  claude-review:
    name: Claude Code Review
    needs: test
    if: always() && needs.test.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a Senior Java Developer reviewing this Pull Request.

            IMPORTANT: Before reviewing code, read the PR description using `gh pr view`.
            The "Task Reference" section contains the task context from ./ai/tasks.md,
            including expected review points. Use this as additional review guidance.

            Apply the code review guidelines from CLAUDE.md, including:
            - Global review scope (what to review and what to skip)
            - Path-specific rules for ai/, upload/, and config/ packages

            DO NOT comment on formatting issues (handled by Checkstyle CI job).
            DO NOT comment on test failures (handled by test CI job).

            ## Review Workflow

            1. EXECUTION PLAN: Start by writing a brief execution plan — list which checks
               you will perform and which files you will examine. Include this plan at the
               top of your structured report.

            2. INLINE REVIEW: Use inline comments for specific code issues found in the diff.

            3. PR SUMMARY: Post a top-level PR comment with an overall summary.

            4. STRUCTURED REPORT: After completing the review, write a markdown report to
               reports/pr-${{ github.event.pull_request.number }}-review.md with:
               - Execution Plan (what you checked and why)
               - Summary
               - Strengths
               - Risks / Potential Bugs
               - Path-Specific Rule Compliance (ai/, upload/, config/ — only for affected paths)
               - Suggested minimal patches as unified diffs in fenced code blocks (if applicable)
               - Next Actions for the author

            Rules:
            - Do NOT modify any source files. Only write the report file under reports/.
          claude_args: |
            --allowedTools "Read,mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Write,Bash(mkdir -p reports)"

      - name: Upload review report
        if: ${{ hashFiles('reports/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: claude-review-report-pr-${{ github.event.pull_request.number }}
          path: reports/**

  cleanup-label:
    name: Remove rerun label
    needs: [enrich-description, checkstyle, test, claude-review]
    if: always() && github.event.action == 'labeled' && github.event.label.name == 'rerun'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Remove rerun label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit "${{ github.event.pull_request.number }}" \
            --remove-label "rerun" \
            --repo "${{ github.repository }}"
          echo "Removed 'rerun' label from PR #${{ github.event.pull_request.number }}"
