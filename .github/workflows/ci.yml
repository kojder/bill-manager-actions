name: CI Pipeline

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  checkstyle:
    name: Checkstyle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        run: ./mvnw checkstyle:check

  test:
    name: Unit Tests
    needs: checkstyle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Tests
        run: ./mvnw test

  claude-review:
    name: Claude Code Review
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a Senior Java Developer reviewing this Pull Request.

            Apply the code review guidelines from CLAUDE.md, including:
            - Global review scope (what to review and what to skip)
            - Path-specific rules for ai/, upload/, and config/ packages

            DO NOT comment on formatting issues (handled by Checkstyle CI job).
            DO NOT comment on test failures (handled by test CI job).

            Use inline comments for specific code issues.
            Post a top-level PR comment with an overall summary.
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
